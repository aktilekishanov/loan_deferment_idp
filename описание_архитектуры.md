# Архитектура реализации MVP для обработки документов (с использованием AWS Step Functions)

Эта архитектура описывает минимально жизнеспособный продукт (MVP) для автоматизированной обработки PDF-документов с использованием AWS-сервисов и Step Functions. Система позволяет клиентам загружать документы, запускать OCR и анализ с помощью Textract и Bedrock, а сотрудникам банка просматривать результаты через веб-интерфейс.

---

## 1. Веб-приложение для клиентов (Streamlit)

**Технология:** Python (Streamlit), развертывание на Streamlit Cloud или EC2.
**Функциональность:**

* Клиент загружает один или несколько PDF-файлов.
* Файлы сохраняются в S3 bucket в папку с уникальным идентификатором `request_id_00X/`.
* После загрузки клиент получает сообщение об успешной отправке («✅ Загружено успешно»).

**Компоненты:**

* Интерфейс Streamlit для загрузки.
* `boto3` SDK для работы с S3.
* Генерация `request_id` через UUID или временную метку.

---

## 2. Оркестрация бэкенда (AWS Step Functions)

Центральный элемент системы — **Step Functions state machine**, которая определяет последовательность шагов и управляет обработкой документов. Каждый шаг представляет собой либо вызов Lambda, либо нативную интеграцию с Textract.

### Шаги рабочего процесса:

1. **Запуск обработки (Trigger Lambda)**

   * **Триггер:** событие S3 `ObjectCreated:Put` (при загрузке файла).
   * **Задача:** Lambda получает bucket и key, инициализирует `status.json` в S3 со статусом `"PROCESSING"`, затем запускает Step Functions state machine, передавая `request_id`, bucket и key.

2. **Запуск Textract (Textract Start)**

   * Step Functions вызывает Textract API (`StartDocumentTextDetection` или `StartDocumentAnalysis`).
   * В state machine используется встроенная интеграция с Textract: Step Functions может ожидать завершения асинхронной задачи, не блокируя Lambda.

3. **Получение результатов Textract (Textract Get Results)**

   * После завершения Textract, Step Functions автоматически вызывает `GetDocumentTextDetection`.
   * Извлечённый структурированный текст сохраняется в S3 в формате JSON (`request_id/intermediate/textract.json`).

4. **Обработка результатов (Lambda #1 — Parser)**

   * Вход: текстовые данные от Textract.
   * Задача: извлечение ключевых сущностей, таблиц, пар «ключ–значение».
   * Выход сохраняется в `request_id/intermediate/parsed.json`.

5. **Вызов Bedrock (Lambda #2 — AI Processing)**

   * Вход: структурированные данные.
   * Задача: вызов модели Bedrock (Claude, Llama, Titan и т.д.) для классификации документа и извлечения бизнес-полей (например: `client_name`, `loan_number`, `request_type`).
   * Результаты сохраняются в `request_id/processed/final.json`.

6. **Завершение обработки (Lambda #3 — Finalizer)**

   * Обновление `status.json` со статусом `"COMPLETE"`.
   * Пример содержимого:

     ```json
     {
       "status": "COMPLETE",
       "updated_at": "2025-09-30T08:45:00Z",
       "error": null
     }
     ```

---

## 3. Веб-приложение для сотрудников банка (Streamlit)

**Технология:** Python (Streamlit).
**Функциональность:**

* Отображает список всех `request_id` из S3.
* Для каждого запроса показывает:

  * Исходные файлы (просмотр/скачивание).
  * Обработанные данные (`final.json`).
  * Текущий статус (в ожидании, в обработке, завершено, ошибка).
* Возможность фильтровать по статусу или искать по полям (`client_name`, `loan_number`).

**Компоненты:**

* `boto3` для чтения данных из S3.
* Streamlit-таблицы/виджеты для отображения списка заявок.

---

## 4. Стратегия обработки ошибок

1. **Отслеживание статуса в S3**

   * В каждой папке `request_id/` создается `status.json`, который обновляется на каждом шаге.
   * Пример ошибки:

     ```json
     {
       "status": "FAILED",
       "updated_at": "2025-09-30T08:50:00Z",
       "error": "Textract: неверный формат PDF"
     }
     ```

2. **Обработка ошибок в Step Functions**

   * Для каждого шага задаются retry-политики (например, 3 попытки с экспоненциальной задержкой).
   * При неустранимой ошибке state machine переводит процесс в ветку `"FAILED"`, обновляя `status.json`.

3. **DLQ (Dead Letter Queue)**

   * Для всех Lambda, вызываемых внутри Step Functions, настраивается DLQ (SQS).
   * Ошибочные события не теряются, а сохраняются для дальнейшего анализа.

4. **Отображение ошибок в приложении сотрудников**

   * При статусе `"FAILED"` в интерфейсе выводится сообщение вроде:
     «❌ Ошибка обработки: Textract: неверный формат PDF».
   * Доступно скачивание исходных файлов для повторной проверки.

---

## 5. Итоговый стек MVP

* **Фронтенд:**

  * Streamlit (загрузка документов).
  * Streamlit (для сотрудников).

* **Хранилище:**

  * S3 (исходные файлы, промежуточные результаты, финальные JSON, статус).

* **Оркестрация:**

  * AWS Step Functions (state machine для всего процесса).

* **Функции:**

  * Lambda #Trigger — запуск state machine.
  * Lambda #Parser — обработка результатов Textract.
  * Lambda #Bedrock — вызов моделей Bedrock.
  * Lambda #Finalizer — обновление статуса и сохранение финальных данных.

* **Дополнительно:**

  * Textract (OCR и структурирование PDF).
  * Bedrock (извлечение полей/классификация).
  * DLQ (SQS) для надежного логирования ошибок.

---

## 6. Преимущества выбранного подхода

* **Надежность:** Step Functions автоматически управляет последовательностью шагов и повторными попытками.
* **Масштабируемость:** Каждый шаг обрабатывается независимо и масштабируется под нагрузку.
* **Прозрачность:** UI Step Functions позволяет отслеживать прогресс каждого запроса в реальном времени.
* **Простота развития:** Добавление новых шагов (например, валидация данных или дополнительная аналитика) делается без переписывания существующего кода.


